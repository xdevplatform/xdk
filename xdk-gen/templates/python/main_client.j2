"""
Auto-generated main client for the X API.

This module provides the primary Client class for interacting with the X API.
It coordinates all sub-clients and handles authentication, session management,
and OAuth2 PKCE flows. All functionality is generated from the OpenAPI specification.

Generated automatically - do not edit manually.
"""

import requests
from typing import Dict, List, Optional, Union, Any, Callable

from .oauth2_auth import OAuth2PKCEAuth
from .paginator import Cursor, cursor, PaginationError
{% for tag in tags %}
from .{{ tag.import_name }}.client import {{ tag.class_name }}Client
{% endfor %}


class Client:
    """Client for interacting with the X API."""

    def __init__(self, 
                 base_url: str = "https://api.x.com", 
                 bearer_token: str = None, 
                 client_id: str = None, 
                 client_secret: str = None,
                 redirect_uri: str = None,
                 token: Dict[str, Any] = None,
                 scope: Union[str, List[str]] = None,
                 authorization_base_url: str = "https://x.com/i"):
        """Initialize the X API client.

        Args:
            base_url: The base URL for the X API (defaults to https://api.x.com).
            bearer_token: The bearer token for the X API.
            client_id: The client ID for the X API.
            client_secret: The client secret for the X API.
            redirect_uri: The redirect URI for OAuth2 authorization.
            token: An existing OAuth2 token dictionary (if available).
            scope: Space-separated string or list of strings for OAuth2 authorization scopes.
            authorization_base_url: The base URL for OAuth2 authorization (defaults to https://x.com/i).
        """
        self.session = requests.Session()
        self.session.headers.update({
            'User-Agent': 'xdk-python/{{ version }}'
        })
        self.base_url = base_url
        self.bearer_token = bearer_token
        
        # Set up OAuth2 PKCE authentication if credentials are provided
        self.oauth2_auth = None
        if client_id or token:
            self.oauth2_auth = OAuth2PKCEAuth(
                base_url=base_url,
                authorization_base_url=authorization_base_url,
                client_id=client_id,
                client_secret=client_secret,
                redirect_uri=redirect_uri,
                token=token,
                scope=scope
            )
        
        # Initialize clients for each tag
        {% for tag in tags %}
        self.{{ tag.property_name }} = {{ tag.class_name }}Client(self)
        {% endfor %}
    
    @property
    def oauth2_session(self):
        """Get the OAuth2 session if available."""
        if self.oauth2_auth:
            return self.oauth2_auth.oauth2_session
        return None
    
    @property
    def token(self):
        """Get the current OAuth2 token if available."""
        if self.oauth2_auth:
            return self.oauth2_auth.token
        return None
    
    @property
    def access_token(self):
        """Get the current access token if available."""
        if self.oauth2_auth:
            return self.oauth2_auth.access_token
        return None
    
    def get_authorization_url(self, state=None):
        """Get the authorization URL for the OAuth2 PKCE flow.
        
        Args:
            state: Optional state parameter for security.
            
        Returns:
            str: The authorization URL.
        """
        if not self.oauth2_auth:
            raise ValueError("OAuth2 credentials not configured")
        return self.oauth2_auth.get_authorization_url(state)
    
    def exchange_code(self, code, code_verifier=None):
        """Exchange authorization code for tokens (matches TypeScript API).
        
        Args:
            code: The authorization code from the callback.
            code_verifier: Optional code verifier (uses stored verifier if not provided).
            
        Returns:
            Dict[str, Any]: The token dictionary
        """
        if not self.oauth2_auth:
            raise ValueError("OAuth2 credentials not configured")
        return self.oauth2_auth.exchange_code(code, code_verifier)
    
    def fetch_token(self, authorization_response):
        """Fetch token using authorization response URL (legacy method).
        
        Args:
            authorization_response: The full callback URL received after authorization.
            
        Returns:
            Dict[str, Any]: The token dictionary
        """
        if not self.oauth2_auth:
            raise ValueError("OAuth2 credentials not configured")
        return self.oauth2_auth.fetch_token(authorization_response)
    
    def refresh_token(self):
        """Refresh the OAuth2 token."""
        if not self.oauth2_auth:
            raise ValueError("OAuth2 credentials not configured")
        return self.oauth2_auth.refresh_token()
    
    def is_token_expired(self):
        """Check if the OAuth2 token is expired."""
        if not self.oauth2_auth:
            return True
        return self.oauth2_auth.is_token_expired() 